name: Validate Configs

on:
  pull_request:
    paths:
      - 'configs/configs.json'
      - 'configs/screenshots/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Validate JSON syntax
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ configs.json..."
          if ! python3 -m json.tool configs/configs.json > /dev/null 2>&1; then
            echo "‚ùå –û—à–∏–±–∫–∞: configs.json —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ JSON"
            exit 1
          fi
          echo "‚úÖ JSON —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–µ—Ä–Ω—ã–π"
          
      - name: Validate config structure
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥–æ–≤..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          try {
            const data = JSON.parse(fs.readFileSync('configs/configs.json', 'utf8'));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º meta
            if (!data.meta) {
              console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ–∫—Ü–∏—è meta');
              process.exit(1);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º configs
            if (!Array.isArray(data.configs)) {
              console.error('‚ùå configs –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º');
              process.exit(1);
            }
            
            const requiredFields = ['id', 'name', 'addon', 'description', 'config', 'author'];
            const validAddons = ['elvui', 'wa', 'details', 'plater', 'dbm', 'bigwigs'];
            const validClasses = ['warrior', 'paladin', 'deathknight', 'mage', 'priest', 'rogue', 'shaman', 'hunter', 'warlock', 'druid', 'universal'];
            const validRoles = ['tank', 'healer', 'dps', 'all'];
            
            let errors = [];
            
            data.configs.forEach((config, index) => {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
              requiredFields.forEach(field => {
                if (!config[field]) {
                  errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index} (\${config.name || '–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}): –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ \${field}\`);
                }
              });
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID
              const duplicate = data.configs.find((c, i) => c.id === config.id && i !== index);
              if (duplicate) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è ID '\${config.id}'\`);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π
              if (config.addon && !validAddons.includes(config.addon)) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ addon: '\${config.addon}'\`);
              }
              
              if (config.class && !validClasses.includes(config.class)) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ class: '\${config.class}'\`);
              }
              
              if (config.role && !validRoles.includes(config.role)) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ role: '\${config.role}'\`);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞
              if (config.config && config.config.length > 100000) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –∫–æ–Ω—Ñ–∏–≥ (\${config.config.length} —Å–∏–º–≤–æ–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 100000)\`);
              }
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è
              if (config.name && config.name.length > 100) {
                errors.push(\`–ö–æ–Ω—Ñ–∏–≥ #\${index}: —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (\${config.name.length} —Å–∏–º–≤–æ–ª–æ–≤, –º–∞–∫—Å–∏–º—É–º 100)\`);
              }
            });
            
            if (errors.length > 0) {
              console.error('‚ùå –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏:');
              errors.forEach(error => console.error('   - ' + error));
              process.exit(1);
            }
            
            console.log(\`‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ \${data.configs.length} –∫–æ–Ω—Ñ–∏–≥–æ–≤, –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ\`);
            
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ:', error.message);
            process.exit(1);
          }
          "
          
      - name: Check screenshot sizes
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤..."
          if [ -d "configs/screenshots" ]; then
            find configs/screenshots -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.gif" \) | \
            while read file; do
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              if [ $size -gt 2097152 ]; then
                echo "‚ùå –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª: $file ($size –±–∞–π—Ç, –º–∞–∫—Å–∏–º—É–º 2MB)"
                exit 1
              fi
            done
          fi
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          
      - name: Comment on success
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!\n\n–ö–æ–Ω—Ñ–∏–≥ –≥–æ—Ç–æ–≤ –∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—é. –í–ª–∞–¥–µ–ª–µ—Ü —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–≤–µ—Ä–∏—Ç –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∏ –¥–æ–±–∞–≤–∏—Ç –≤ –±–∞–∑—É.'
            })
            
      - name: Comment on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ Pull Request. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å JSON —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞\n2. –ù–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π\n3. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å ID –∫–æ–Ω—Ñ–∏–≥–æ–≤\n4. –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ –±–æ–ª–µ–µ 2MB)'
            })
